<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ChatApp.Client.Views.ChatPage"
             Title="Chat">

    <Grid RowDefinitions="Auto,*,Auto" RowSpacing="0">

        <!-- Header -->
        <Grid Grid.Row="0" Padding="16,14" Background="{StaticResource HeaderBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="2">
                <Label Text="Chat publiczny"
                       FontSize="18"
                       FontAttributes="Bold" />
                <Label Text="{Binding StatusMessage}"
                       FontSize="12"
                       TextColor="{StaticResource ColorText2}" />
            </VerticalStackLayout>

            <Button Grid.Row="0" Grid.Column="1"
                    Text="Połącz"
                    Command="{Binding ConnectCommand}"
                    Background="{StaticResource PrimaryButtonBrush}"
                    Padding="18,0">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding IsConnected}" Value="True">
                        <Setter Property="Text" Value="Rozłącz" />
                        <Setter Property="BackgroundColor" Value="{StaticResource ColorDanger}" />
                    </DataTrigger>
                </Button.Triggers>
            </Button>

            <Label Grid.Row="1" Grid.ColumnSpan="2"
                   Text="Wpisz nick, połącz się i pisz wiadomości."
                   FontSize="11"
                   TextColor="{StaticResource ColorText2}"
                   Margin="0,10,0,0" />
        </Grid>

        <!-- Messages -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Messages}"
                        SelectionMode="None">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="12,0">
                        <Border StrokeThickness="0"
                                StrokeShape="RoundRectangle 16"
                                Background="{StaticResource ColorSurface0}"
                                Padding="12,10"
                                HorizontalOptions="Start"
                                MaximumWidthRequest="520">

                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsMine}" Value="True">
                                    <Setter Property="Background" Value="{StaticResource PrimaryButtonBrush}" />
                                    <Setter Property="HorizontalOptions" Value="End" />
                                </DataTrigger>
                            </Border.Triggers>

                            <VerticalStackLayout Spacing="4">
                                <Label Text="{Binding NickName}"
                                       FontSize="11"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource ColorText1}">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsMine}" Value="True">
                                            <Setter Property="TextColor" Value="{StaticResource ColorText0}" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>

                                <Label Text="{Binding Content}"
                                       FontSize="14"
                                       LineBreakMode="WordWrap" />

                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                       FontSize="10"
                                       TextColor="{StaticResource ColorText2}"
                                       HorizontalOptions="End">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsMine}" Value="True">
                                            <Setter Property="TextColor" Value="{StaticResource ColorText0}" />
                                            <Setter Property="Opacity" Value="0.85" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </VerticalStackLayout>

                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Composer -->
        <Grid Grid.Row="2" Padding="12" Background="{StaticResource HeaderBrush}" RowSpacing="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Nickname (only when disconnected) -->
            <Grid Grid.Row="0"
                  IsVisible="{Binding IsConnected, Converter={StaticResource InvertedBoolConverter}}"
                  ColumnDefinitions="*,Auto"
                  ColumnSpacing="10">
                <Entry Grid.Column="0"
                       Placeholder="Twój nick"
                       Text="{Binding NickName}" />
                <Button Grid.Column="1"
                        Text="Połącz"
                        Command="{Binding ConnectCommand}"
                        Background="{StaticResource PrimaryButtonBrush}"
                        Padding="18,0" />
            </Grid>

            <!-- Message -->
            <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="10">
                <Entry Grid.Column="0"
                       Placeholder="Napisz wiadomość…"
                       Text="{Binding MessageText}"
                       IsEnabled="{Binding IsConnected}"
                       ReturnType="Send"
                       ReturnCommand="{Binding SendMessageCommand}" />

                <Button Grid.Column="1"
                        Text="Wyślij"
                        Command="{Binding SendMessageCommand}"
                        IsEnabled="{Binding IsConnected}"
                        Background="{StaticResource PrimaryButtonBrush}"
                        Padding="18,0" />
            </Grid>
        </Grid>

    </Grid>
</ContentPage>
